# REST API

Базовый URL: `http://localhost:3000` (для Android-эмулятора: `http://10.0.2.2:3000`).

Все запросы (кроме login и health) требуют заголовок: `Authorization: Bearer <token>`.

**Токен:** JWT с подписью, срок действия 24 часа. При истечении — 401 «Токен истёк. Войдите снова.»

---

## Авторизация

### POST /api/auth/login

**Auth:** не требуется.

**Rate limit:** 5 попыток за 15 минут. При превышении — 429.

**Body:**
```json
{
  "login": "string",
  "password": "string"
}
```

**Успех (200):**
```json
{
  "user": {
    "id": "string",
    "login": "string",
    "name": "string",
    "role": "administrator" | "director" | "user"
  },
  "token": "string"
}
```

**Ошибки:**
| Код | Условие | Body |
|-----|---------|------|
| 400 | Нет login или password | `{ "error": "Логин и пароль обязательны" }` |
| 401 | Неверный логин или пароль | `{ "error": "Неверный логин или пароль" }` |
| 429 | Слишком много попыток | `{ "error": "Слишком много попыток. Попробуйте через 15 минут." }` |

---

## Заявки

### GET /api/requests

**Query:**
| Параметр | Тип | Описание |
|----------|-----|----------|
| `show_completed` | string | `"true"` — включить выполненные заявки |

**Успех (200):** массив заявок (без фото).

**Фильтрация:** Админ/Директор видят все; Пользователь — только свои (постановщик или ответственный).

---

### GET /api/requests/:id

**Успех (200):** объект заявки с полем `photoBase64: string[]`.

**Ошибки:**
| Код | Условие |
|-----|---------|
| 404 | Заявка не найдена |
| 403 | Нет доступа |

---

### POST /api/requests

**Body:**
| Поле | Тип | Обязательно | Описание |
|------|-----|------------|----------|
| `title` | string | да | Заголовок (≤200 символов) |
| `description` | string | да | Описание (≤5000 символов) |
| `priority` | string | нет | Низкий, Средний, Высокий, Критический |
| `roomId` | string | нет | ID комнаты (должен существовать) |
| `responsibleUserId` | string | нет | ID ответственного (должен существовать) |
| `requestTypeId` | string | нет | ID типа заявки (должен существовать) |
| `photoBytes` | string[] | нет | Массив base64 JPEG/PNG (≤10 шт., ≤5 MB каждое) |

**Примечание:** `requestorUserId` не передаётся — backend берёт из токена (текущий пользователь).

**Успех (201):** созданная заявка.

**Ошибки:**
| Код | Условие | Body |
|-----|---------|------|
| 400 | Валидация | `{ "error": "Заголовок обязателен" }` и др. |

---

### PUT /api/requests/:id

**Права:** постановщик или админ/директор.

**Body:** все поля опциональны — `title`, `description`, `priority`, `roomId`, `responsibleUserId`, `requestTypeId`, `photoBytes`. Те же лимиты, что в POST.

**Успех (200):** `{ "ok": true }`.

**Ошибки:**
| Код | Условие |
|-----|---------|
| 400 | Валидация (длина, фото, справочники) |
| 404 | Заявка не найдена |
| 403 | Только постановщик может редактировать |

---

### PATCH /api/requests/:id/status

**Права:** постановщик, ответственный или админ/директор.

**Body:**
```json
{ "statusId": "string" }
```

**Успех (200):** `{ "ok": true }`.

**Ошибки:**
| Код | Условие |
|-----|---------|
| 400 | Нет statusId или статус не найден |
| 403 | Нет прав на изменение статуса |
| 404 | Заявка не найдена |

---

### PATCH /api/requests/:id/rating

**Права:** только админ или директор.

**Body:**
```json
{ "rating": 1 | 2 | 3 | 4 | 5 }
```

**Успех (200):** `{ "ok": true }`.

**Ошибки:**
| Код | Условие |
|-----|---------|
| 403 | Только администратор или директор может оценивать |
| 404 | Заявка не найдена |

---

### DELETE /api/requests/:id

**Права:** постановщик или админ/директор.

**Успех (204):** пустое тело.

**Ошибки:**
| Код | Условие |
|-----|---------|
| 403 | Только постановщик может удалить |
| 404 | Заявка не найдена |

---

## Справочники

### GET /api/rooms

**Успех (200):** `[{ "id", "number", "description" }, ...]`

---

### GET /api/statuses

**Успех (200):** `[{ "id", "name", "code", "color", "sort_order" }, ...]`

Коды статусов: `new`, `in_progress`, `completed`, `cancelled`.

---

### GET /api/types

**Успех (200):** `[{ "id", "name", "sort_order" }, ...]`

---

### GET /api/users/for-responsible

**Успех (200):** массив пользователей с ролью `user` — для выбора ответственного.

---

## Служебный

### GET /api/health

**Auth:** не требуется.

**Успех (200):** `{ "ok": true }`
